name: Build and Release

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  # Path to the solution file relative to the root of the project.
  VERSION: 1.0.0.2
  BUILD_CONFIGURATION: Release
  FILELIST_URL: ${{vars.FILELIST_URL}}
  SERVER_NAME: ${{vars.SERVER_NAME}}
  STORAGE_URL: ${{vars.STORAGE_URL}}

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Restore NuGet packages
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: cd "EQEmu Patcher" && nuget restore "EQEmu Patcher.sln"

    - name: Build
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: |
        cd "EQEmu Patcher" && msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} /p:Version=${{env.VERSION}} /p:FILELIST_URL=${{env.FILELIST_URL}} /p:SERVER_NAME="${{env.SERVER_NAME}}" "EQEmu Patcher.sln"
        copy "EQEmu Patcher/bin/Release/eqemupatcher.exe" eqemupatcher.exe
    - name: Checksum Binary
      run: bash -c 'cd EQEmu\ Patcher && md5=($(md5sum -b eqemupatcher.exe)) && echo "launcheq.exe md5 is set to $md5" && echo $md5 > eqemupatcher-hash.txt'
    - name: Generate patch
      run: |
        C:\msys64\usr\bin\wget.exe --no-verbose https://github.com/xackery/filelistbuilder/releases/download/latest/filelistbuilder-win-x64.exe
        .\filelistbuilder-win-x64.exe rof $STORAGE_URL "EQEmu Patcher/EQEmu Patcher/bin/Release/eqemupatcher.exe"
    - uses: "marvinpinto/action-automatic-releases@latest"
      name: Release
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        automatic_release_tag: "latest"
        prerelease: false
        title: "Latest Release"
        files: |
          EQEmu Patcher/EQEmu Patcher/bin/Release/eqemupatcher.exe
          filelist_rof.yml
